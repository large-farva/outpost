#!/usr/bin/env bash
set -euo pipefail

VERSION="1.2"

usage() {
  cat <<'EOF'
Usage: reader-list [--help] [--version]

Lists detected smart card readers using opensc-tool.

EOF
}

case "${1:-}" in
  -h|--help) usage; exit 0 ;;
  --version) printf '%s\n' "$VERSION"; exit 0 ;;
esac

# shellcheck source=lib.sh
source /usr/lib/outpost/lib.sh

hdr "CAC readers"
dim "Listing detected smart card readers."
printf '\n'

output="$(opensc-tool -l 2>/dev/null || true)"

if grep -qi "no smart card readers" <<< "$output"; then
  line "$(warn)" "No smart card readers detected"
  exit 1
fi

box <<< "$output"
printf '\n'
line "$(ok)" "Smart card reader(s) detected"
exit 0
