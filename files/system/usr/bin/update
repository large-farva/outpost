#!/usr/bin/env bash
set -euo pipefail

# Pick the active "automatic updates" unit name, if present
if systemctl cat --quiet uupd.timer &>/dev/null; then
  SERVICE="uupd.service"
else
  SERVICE="rpm-ostreed-automatic.service"
fi

if systemctl is-active --quiet "$SERVICE"; then
  echo "automatic updates are currently running, use \`journalctl -fexu $SERVICE\` to see logs"
  exit 1
fi

if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  if command -v sudo >/dev/null 2>&1; then
    exec sudo -E "$0" "$@"
  fi
  echo "Error: sudo is required to update the OS (rpm-ostree). Install sudo or run as root." >&2
  exit 1
fi

echo "Updating OS (rpm-ostree)..."
rpm-ostree upgrade

if command -v flatpak >/dev/null 2>&1; then
  if flatpak --system remotes >/dev/null 2>&1 && [[ -n "$(flatpak --system remotes 2>/dev/null | awk 'NF{print; exit}')" ]]; then
    echo "Updating system Flatpaks..."
    flatpak --system update -y
  fi

  TARGET_USER="${SUDO_USER:-}"
  if [[ -n "$TARGET_USER" ]]; then
    if sudo -u "$TARGET_USER" flatpak --user remotes >/dev/null 2>&1 \
      && [[ -n "$(sudo -u "$TARGET_USER" flatpak --user remotes 2>/dev/null | awk 'NF{print; exit}')" ]]; then
      echo "Updating user Flatpaks for $TARGET_USER..."
      sudo -u "$TARGET_USER" flatpak --user update -y
    fi
  fi
fi

TARGET_USER="${SUDO_USER:-}"
if [[ -n "$TARGET_USER" ]] && [[ -x "/var/home/$TARGET_USER/.linuxbrew/bin/brew" ]]; then
  echo "Updating Homebrew packages for $TARGET_USER..."
  sudo -u "$TARGET_USER" "/var/home/$TARGET_USER/.linuxbrew/bin/brew" upgrade || true
fi

echo
echo "Update staged. Reboot to apply: systemctl reboot"
