#!/usr/bin/env bash
set -euo pipefail

# Simple helper for updating an rpm-ostree based system.
# Handles OS updates, Flatpaks, and Homebrew (if present).

VERSION="1.0"

usage() {
  cat <<'EOF'
Usage: update [--help] [--version]

Runs:
  - rpm-ostree upgrade
  - system Flatpak updates
  - user Flatpak updates (if applicable)
  - Homebrew upgrade for the invoking user (if present)

A reboot is required to apply OS updates.
EOF
}

err() { printf 'Error: %s\n' "$*" >&2; }
msg() { printf '%s\n' "$*"; }

case "${1:-}" in
  -h|--help) usage; exit 0 ;;
  --version) printf '%s\n' "$VERSION"; exit 0 ;;
esac

have() { command -v "$1" >/dev/null 2>&1; }

# rpm-ostree requires root. If we're not root, re-exec via sudo.
if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  if have sudo; then
    exec sudo -E "$0" "$@"
  fi
  err "sudo is required to update the OS (rpm-ostree)."
  exit 1
fi

TARGET_USER="${SUDO_USER:-}"

# OS updates
msg "Updating OS (rpm-ostree)..."
rpm-ostree upgrade

# Flatpak
if have flatpak; then
  msg "Updating system Flatpaks..."
  flatpak --system update -y

  if [[ -n "$TARGET_USER" ]]; then
    msg "Updating user Flatpaks for $TARGET_USER..."
    sudo -u "$TARGET_USER" flatpak --user update -y
  fi
fi

# Homebrew
if [[ -n "$TARGET_USER" ]]; then
  BREW="/var/home/$TARGET_USER/.linuxbrew/bin/brew"
  if [[ -x "$BREW" ]]; then
    msg "Updating Homebrew packages for $TARGET_USER..."
    sudo -u "$TARGET_USER" "$BREW" upgrade || true
  fi
fi

msg ""
msg "Update staged. Reboot to apply: systemctl reboot"
