#!/usr/bin/env bash
set -euo pipefail

VERSION="1.2"

usage() {
  cat <<'EOF'
Usage: update [--help] [--version]

Runs:
  - rpm-ostree upgrade
  - system Flatpak updates
  - user Flatpak updates (if applicable)
  - Homebrew upgrade for the invoking user (if present)

A reboot is required to apply OS updates.
EOF
}

case "${1:-}" in
  -h|--help) usage; exit 0 ;;
  --version) printf '%s\n' "$VERSION"; exit 0 ;;
esac

have() { command -v "$1" >/dev/null 2>&1; }

TARGET_USER="${SUDO_USER:-$USER}"

hdr() {
  gum style --border rounded --padding "0 1" --margin "0 0 1 0" \
    --border-foreground 68 --foreground 68 --bold "Outpost update"
}

dim()  { gum style --foreground 244 "$*"; }
ok()   { gum style --foreground 42  --bold "✓"; }
warn() { gum style --foreground 214 --bold "!"; }
bad()  { gum style --foreground 196 --bold "✗"; }

line() {
  local icon="$1"; shift
  printf '%s %s\n' "$icon" "$*"
}

spin() {
  local title="$1"; shift
  gum spin --spinner points --spinner.foreground="68" --title "$title" -- "$@"
}

xdg_data_dirs="/var/lib/flatpak/exports/share:/usr/local/share:/usr/share${XDG_DATA_DIRS:+:$XDG_DATA_DIRS}"

os_update_staged() {
  /usr/bin/rpm-ostree status --json | /usr/bin/jq -e ".deployments[0].booted == false" >/dev/null 2>&1
}

hdr
dim "Stages updates. Reboot required to apply OS changes."
printf '\n'

# OS
if spin "OS: rpm-ostree upgrade (may take a while)" rpm-ostree upgrade; then
  if os_update_staged; then
    line "$(ok)" "OS update staged"
  else
    line "$(warn)" "No OS update available"
  fi
else
  line "$(bad)" "OS update failed"
  exit 1
fi

# Flatpak
if have flatpak; then
  if spin "Flatpaks: system update" env XDG_DATA_DIRS="$xdg_data_dirs" flatpak --system update -y; then
    line "$(ok)" "System Flatpaks updated"
  else
    line "$(bad)" "System Flatpak update failed"
    exit 1
  fi

  if [[ -n "$TARGET_USER" ]]; then
    if spin "Flatpaks: user update ($TARGET_USER)" sudo -u "$TARGET_USER" env XDG_DATA_DIRS="$xdg_data_dirs" flatpak --user update -y; then
      line "$(ok)" "User Flatpaks updated ($TARGET_USER)"
    else
      line "$(bad)" "User Flatpak update failed ($TARGET_USER)"
      exit 1
    fi
  fi
fi

# Homebrew
BREW="/var/home/linuxbrew/.linuxbrew/bin/brew"
if [[ -x "$BREW" ]]; then
  if spin "Homebrew: upgrade" sudo -u "$TARGET_USER" "$BREW" upgrade; then
    line "$(ok)" "Homebrew packages updated"
  else
    line "$(warn)" "Homebrew upgrade returned non-zero (continuing)"
  fi
fi

printf '\n'

if os_update_staged; then
  gum style --foreground 68 --bold "Update staged."
  dim "Reboot to apply: systemctl reboot"
else
  gum style --foreground 68 --bold "No OS update staged."
fi
