#!/usr/bin/env bash
set -euo pipefail

VERSION="1.1"

usage() {
  cat <<'EOF'
Usage: update [--help] [--version]

Runs:
  - rpm-ostree upgrade
  - system Flatpak updates
  - user Flatpak updates (if applicable)
  - Homebrew upgrade for the invoking user (if present)

A reboot is required to apply OS updates.
EOF
}

err() { printf 'Error: %s\n' "$*" >&2; }

case "${1:-}" in
  -h|--help) usage; exit 0 ;;
  --version) printf '%s\n' "$VERSION"; exit 0 ;;
esac

have() { command -v "$1" >/dev/null 2>&1; }

TARGET_USER="${SUDO_USER:-$USER}"

hdr() {
  gum style --bold --foreground 212 "Outpost update"
}

step() {
  gum style --bold --foreground 75 "$1"
}

run() {
  local title="$1"; shift
  gum spin --spinner dot --title "$title" -- "$@"
}

ok() {
  gum style --foreground 42 "Done"
}

note() {
  gum style --foreground 244 "$*"
}

hdr
note "This will stage an OS update if available. Reboot required to apply."

# OS updates
step "OS (rpm-ostree)"
run "Running rpm-ostree upgrade..." rpm-ostree upgrade
ok

# Flatpak
if have flatpak; then
  step "Flatpaks"

  # system
  run "Updating system Flatpaks..." \
    env XDG_DATA_DIRS="/var/lib/flatpak/exports/share:/usr/local/share:/usr/share${XDG_DATA_DIRS:+:$XDG_DATA_DIRS}" \
    flatpak --system update -y
  ok

  # user
  if [[ -n "$TARGET_USER" ]]; then
    run "Updating user Flatpaks for $TARGET_USER..." \
      sudo -u "$TARGET_USER" \
      env XDG_DATA_DIRS="/var/lib/flatpak/exports/share:/usr/local/share:/usr/share${XDG_DATA_DIRS:+:$XDG_DATA_DIRS}" \
      flatpak --user update -y
    ok
  fi
fi

# Homebrew
BREW="/var/home/$TARGET_USER/.linuxbrew/bin/brew"
if [[ -x "$BREW" ]]; then
  step "Homebrew"
  if ! run "Updating Homebrew packages for $TARGET_USER..." sudo -u "$TARGET_USER" "$BREW" upgrade; then
    gum style --foreground 214 "Homebrew upgrade returned non-zero (continuing)."
  else
    ok
  fi
fi

printf '\n'
gum style --bold --foreground 212 "Update staged."
note "Reboot to apply: systemctl reboot"
