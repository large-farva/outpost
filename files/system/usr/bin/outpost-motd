#!/usr/bin/env bash
set -euo pipefail

IMAGE_INFO="/usr/share/outpost/image-info.json"
MOTD_TEMPLATE="/usr/share/outpost/motd/template.md"
MOTD_OUTPUT="/run/motd.d/outpost.motd"

[[ -f "$IMAGE_INFO" ]] || exit 0
[[ -f "$MOTD_TEMPLATE" ]] || exit 0

command -v jq >/dev/null 2>&1 || exit 0

export MOTD_IMAGE_REF="$(jq -r '."image-ref"' "$IMAGE_INFO")"
export MOTD_IMAGE_TAG="$(jq -r '."image-tag"' "$IMAGE_INFO")"
export MOTD_FEDORA_VERSION="$(jq -r '."fedora-version"' "$IMAGE_INFO")"

mkdir -p "$(dirname "$MOTD_OUTPUT")"

envsubst < "$MOTD_TEMPLATE" > "$MOTD_OUTPUT"