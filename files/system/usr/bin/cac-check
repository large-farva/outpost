#!/usr/bin/env bash
set -euo pipefail

VERSION="1.1"

usage() {
  cat <<'EOF'
Usage: cac-check [--help] [--version]

Checks:
  - pcscd.socket status
  - OpenSC PKCS#11 module presence
  - p11-kit visibility (if available)
  - DoD trust anchor presence
  - Trust store entries (best effort)

EOF
}

err() { printf 'Error: %s\n' "$*" >&2; }

case "${1:-}" in
  -h|--help) usage; exit 0 ;;
  --version) printf '%s\n' "$VERSION"; exit 0 ;;
esac

have() { command -v "$1" >/dev/null 2>&1; }

hdr() {
  gum style --bold --foreground 212 "CAC readiness check"
}

step() {
  gum style --bold --foreground 75 "$1"
}

ok() {
  gum style --foreground 42 "Done"
}

note() {
  gum style --foreground 244 "$*"
}

warn() {
  gum style --foreground 214 "$*"
}

bad() {
  gum style --foreground 196 "$*"
}

fail=0
hdr

# pcscd
step "PC/SC (pcscd)"

if systemctl is-enabled pcscd.socket >/dev/null 2>&1; then
  note "pcscd.socket enabled"
else
  bad "pcscd.socket not enabled"
  fail=1
fi

if systemctl is-active pcscd.socket >/dev/null 2>&1; then
  note "pcscd.socket active"
else
  warn "pcscd.socket not active (socket activation may be used)"
fi

if systemctl list-unit-files pcscd.service >/dev/null 2>&1; then
  if systemctl is-active pcscd.service >/dev/null 2>&1; then
    note "pcscd.service active"
  else
    warn "pcscd.service not active (socket activation may be used)"
  fi
fi

ok

# opensc
step "OpenSC"

OPENSC_LIB=""
for p in /usr/lib64/pkcs11/opensc-pkcs11.so /usr/lib64/opensc-pkcs11.so; do
  if [[ -f "$p" ]]; then
    OPENSC_LIB="$p"
    break
  fi
done

if [[ -n "$OPENSC_LIB" ]]; then
  note "PKCS#11 module: $OPENSC_LIB"
else
  bad "OpenSC PKCS#11 module not found"
  fail=1
fi

if have opensc-tool; then
  note "opensc-tool: present"
else
  warn "opensc-tool: not found"
fi

ok

# p11-kit
step "p11-kit"

if have p11-kit && [[ -n "$OPENSC_LIB" ]]; then
  if p11-kit list-modules 2>/dev/null | grep -Fq "$OPENSC_LIB"; then
    note "p11-kit sees OpenSC"
  else
    warn "p11-kit does not list OpenSC (may still work via proxy)"
  fi
else
  warn "p11-kit not available"
fi

ok

# trust bundle
step "Trust"

ANCHOR="/etc/pki/ca-trust/source/anchors/dod-trust-bundle.pem"
if [[ -f "$ANCHOR" ]]; then
  note "DoD trust anchor: present"
else
  bad "DoD trust anchor missing: $ANCHOR"
  fail=1
fi

if have trust; then
  if trust list 2>/dev/null | grep -qi -m 1 'dod '; then
    note "Trust store contains DoD entries"
  else
    warn "No obvious DoD entries found in trust list"
  fi
else
  warn "'trust' command not available"
fi

ok

printf '\n'
step "Tips"
note "Insert CAC and run: pcsc_scan"
note "Reader list: opensc-tool -l"
note "NSS modules: modutil -list -dbdir sql:$HOME/.pki/nssdb"
note "OpenSC module path: ${OPENSC_LIB:-/usr/lib64/pkcs11/opensc-pkcs11.so}"

exit "$fail"
