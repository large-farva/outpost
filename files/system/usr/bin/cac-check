#!/usr/bin/env bash
set -euo pipefail

VERSION="2.0"

usage() {
  cat <<'EOF'
Usage: cac-check [--help] [--version]

Checks CAC readiness across five areas:

  - PC/SC daemon status
  - PKCS#11 stack (OpenSC, p11-kit)
  - DoD trust store
  - Firefox / NSS database
  - Smart card reader detection

EOF
}

case "${1:-}" in
  -h|--help) usage; exit 0 ;;
  --version) printf '%s\n' "$VERSION"; exit 0 ;;
esac

# shellcheck source=lib.sh
source /usr/lib/outpost/lib.sh

passes=0
warnings=0
failures=0

check_ok() {
  ((++passes))
  line "$(ok)" "$*"
}

check_warn() {
  ((++warnings))
  line "$(warn)" "$*"
}

check_fail() {
  ((++failures))
  line "$(bad)" "$*"
}

hdr "CAC readiness check"

# ── PC/SC Daemon ──────────────────────────────────────────────
section "PC/SC Daemon"

if systemctl is-enabled pcscd.socket >/dev/null 2>&1; then
  check_ok "pcscd.socket enabled"
else
  check_fail "pcscd.socket not enabled"
fi

if systemctl is-active pcscd.socket >/dev/null 2>&1; then
  check_ok "pcscd.socket active"
else
  check_warn "pcscd.socket not active (socket activation may be used)"
fi

if systemctl list-unit-files pcscd.service 2>/dev/null | grep -q pcscd.service; then
  if systemctl is-active pcscd.service >/dev/null 2>&1; then
    check_ok "pcscd.service active"
  else
    check_warn "pcscd.service not active (socket activation may be used)"
  fi
fi

printf '\n'

# ── PKCS#11 Stack ─────────────────────────────────────────────
section "PKCS#11 Stack"

OPENSC_LIB=""
for p in /usr/lib64/pkcs11/opensc-pkcs11.so /usr/lib64/opensc-pkcs11.so; do
  [[ -f "$p" ]] && OPENSC_LIB="$p" && break
done

if [[ -n "$OPENSC_LIB" ]]; then
  check_ok "OpenSC module: $OPENSC_LIB"
else
  check_fail "OpenSC PKCS#11 module not found"
fi

if [[ -n "$OPENSC_LIB" ]] && p11-kit list-modules 2>/dev/null | grep -Fq "$OPENSC_LIB"; then
  check_ok "p11-kit sees OpenSC"
else
  check_warn "p11-kit did not list OpenSC (may still work via proxy)"
fi

printf '\n'

# ── DoD Trust Store ───────────────────────────────────────────
section "DoD Trust Store"

ANCHOR="/etc/pki/ca-trust/source/anchors/dod-trust-bundle.pem"
if [[ -f "$ANCHOR" ]]; then
  check_ok "Trust anchor installed"
else
  check_fail "Trust anchor missing: $ANCHOR"
fi

dod_cas="$(trust list --filter=ca-anchors 2>/dev/null | grep -Eci 'dod' || true)"
if ((dod_cas > 0)); then
  check_ok "$dod_cas DoD CA entries in trust store"
else
  check_warn "No DoD-related CA entries found in trust store"
fi

printf '\n'

# ── Firefox / NSS ─────────────────────────────────────────────
section "Firefox / NSS"

NSSDB_DIR="$HOME/.pki/nssdb"
NSSDB="sql:$NSSDB_DIR"

if [[ -f "$NSSDB_DIR/cert9.db" ]]; then
  check_ok "NSS database initialized"

  nss_list="$(modutil -list -dbdir "$NSSDB" 2>/dev/null || true)"

  if grep -Fq "p11-kit-proxy" <<< "$nss_list"; then
    check_ok "NSS provider: p11-kit-proxy"
  elif grep -Fq "opensc-pkcs11.so" <<< "$nss_list"; then
    check_ok "NSS provider: opensc-pkcs11.so"
  else
    check_warn "No CAC PKCS#11 provider in NSS"
  fi
else
  check_warn "NSS database not initialized (~/.pki/nssdb)"
fi

printf '\n'

# ── Reader ────────────────────────────────────────────────────
section "Reader"

reader_output="$(opensc-tool -l 2>/dev/null || true)"

if [[ -n "$reader_output" ]] && ! grep -qi "no smart card readers" <<< "$reader_output"; then
  reader_count="$(wc -l <<< "$reader_output")"
  check_ok "$reader_count reader(s) detected"
else
  check_warn "No smart card readers detected"
fi

printf '\n'

# ── Summary ───────────────────────────────────────────────────
summary="$(ok) $passes passed"
((warnings > 0)) && summary="$summary  $(warn) $warnings warning(s)"
((failures > 0)) && summary="$summary  $(bad) $failures failed"

box <<< "$summary"

exit "$((failures > 0 ? 1 : 0))"
