#!/usr/bin/env bash
set -euo pipefail

ok()  { printf '✅ %s\n' "$*"; }
bad() { printf '❌ %s\n' "$*"; }
warn(){ printf '⚠️  %s\n' "$*"; }

printf '%s\n' "CAC readiness check"
printf '%s\n' "-------------------------"

if systemctl is-enabled pcscd.socket >/dev/null 2>&1; then
  ok "pcscd.socket is enabled"
else
  bad "pcscd.socket is NOT enabled"
fi

if systemctl is-active pcscd.socket >/dev/null 2>&1; then
  ok "pcscd.socket is active"
else
  warn "pcscd.socket is not active (it may activate on demand when a reader is used)"
fi

OPENSC1="/usr/lib64/opensc-pkcs11.so"
OPENSC2="/usr/lib64/pkcs11/opensc-pkcs11.so"

if [[ -f "$OPENSC1" ]]; then
  ok "OpenSC PKCS#11 library present: $OPENSC1"
elif [[ -f "$OPENSC2" ]]; then
  ok "OpenSC PKCS#11 library present: $OPENSC2"
else
  bad "OpenSC PKCS#11 library not found in expected locations"
fi

printf '\n%s\n' "Tips:"
printf '%s\n' "  1) Insert CAC and run: pcsc_scan"
printf '%s\n' "  2) In Firefox: Settings → Privacy & Security → Certificates → Security Devices"
printf '%s\n' "     If needed, load OpenSC module at:"
printf '%s\n' "       /usr/lib64/opensc-pkcs11.so  (or /usr/lib64/pkcs11/opensc-pkcs11.so)"
