#!/usr/bin/env bash
set -euo pipefail

VERSION="1.1"

usage() {
  cat <<'EOF'
Usage: cac-check [--help] [--version]

Checks:
  - pcscd.socket status
  - OpenSC PKCS#11 module presence
  - p11-kit visibility (best effort)
  - DoD trust anchor presence
  - Trust store contains DoD-related CAs (best effort)

EOF
}

case "${1:-}" in
  -h|--help) usage; exit 0 ;;
  --version) printf '%s\n' "$VERSION"; exit 0 ;;
esac

have() { command -v "$1" >/dev/null 2>&1; }

hdr() {
  gum style --border rounded --padding "0 1" --margin "0 0 1 0" \
    --border-foreground 212 --foreground 212 --bold "CAC readiness check"
}

dim()  { gum style --foreground 244 "$*"; }
ok()   { gum style --foreground 42  --bold "✓"; }
warn() { gum style --foreground 214 --bold "!"; }
bad()  { gum style --foreground 196 --bold "✗"; }

line() {
  local icon="$1"; shift
  printf '%s %s\n' "$icon" "$*"
}

fail=0
hdr

# PC/SC
if systemctl is-enabled pcscd.socket >/dev/null 2>&1; then
  line "$(ok)" "pcscd.socket enabled"
else
  line "$(bad)" "pcscd.socket not enabled"
  fail=1
fi

if systemctl is-active pcscd.socket >/dev/null 2>&1; then
  line "$(ok)" "pcscd.socket active"
else
  line "$(warn)" "pcscd.socket not active (socket activation may be used)"
fi

if systemctl list-unit-files pcscd.service >/dev/null 2>&1; then
  if systemctl is-active pcscd.service >/dev/null 2>&1; then
    line "$(ok)" "pcscd.service active"
  else
    line "$(warn)" "pcscd.service not active (socket activation may be used)"
  fi
fi

printf '\n'

# OpenSC
OPENSC_LIB=""
for p in /usr/lib64/pkcs11/opensc-pkcs11.so /usr/lib64/opensc-pkcs11.so; do
  [[ -f "$p" ]] && OPENSC_LIB="$p" && break
done

if [[ -n "$OPENSC_LIB" ]]; then
  line "$(ok)" "OpenSC PKCS#11 module: $OPENSC_LIB"
else
  line "$(bad)" "OpenSC PKCS#11 module not found"
  fail=1
fi

if have opensc-tool; then
  line "$(ok)" "opensc-tool present"
else
  line "$(warn)" "opensc-tool not found"
fi

printf '\n'

# p11-kit
if have p11-kit; then
  if [[ -n "$OPENSC_LIB" ]] && p11-kit list-modules 2>/dev/null | grep -Fq "$OPENSC_LIB"; then
    line "$(ok)" "p11-kit sees OpenSC"
  else
    line "$(warn)" "p11-kit did not list OpenSC (may still work via proxy)"
  fi
else
  line "$(warn)" "p11-kit not available"
fi

printf '\n'

# Trust
ANCHOR="/etc/pki/ca-trust/source/anchors/dod-trust-bundle.pem"
if [[ -f "$ANCHOR" ]]; then
  line "$(ok)" "DoD trust anchor installed"
else
  line "$(bad)" "DoD trust anchor missing: $ANCHOR"
  fail=1
fi

if have trust; then
  if trust list --filter=ca-anchors 2>/dev/null | grep -Eqi -m 1 '(DoD|DOD|Department of Defense|U\.S\..*DoD|DISA|Defense Information Systems|IdenTrust|Federal Common Policy|FCPCA|PKE)'; then
    line "$(ok)" "Trust store contains DoD-related CA entries"
  else
    line "$(warn)" "No obvious DoD-related CA strings found (anchor may still be present)"
    dim "Tip: trust list --filter=ca-anchors | less"
  fi
else
  line "$(warn)" "'trust' command not available"
fi

printf '\n'

# Tips
gum style --bold --foreground 75 "Tips"
dim "scan        (or: pcsc_scan)"
dim "reader-list  (or: opensc-tool -l)"
dim "trust-dod    (or: trust list --filter=ca-anchors | grep -Ei '(dod|disa|pke|fcpca)')"
dim "nss-modules  (or: modutil -list -dbdir sql:$HOME/.pki/nssdb)"
dim "OpenSC module path: ${OPENSC_LIB:-/usr/lib64/pkcs11/opensc-pkcs11.so}"

exit "$fail"
