#!/usr/bin/env bash
set -euo pipefail

VERSION="1.2"

usage() {
  cat <<'EOF'
Usage: cac-check [--help] [--version]

Checks:
  - pcscd.socket status
  - OpenSC PKCS#11 module presence
  - p11-kit visibility
  - DoD trust anchor presence
  - Trust store contains DoD-related CAs
  - NSS module list

EOF
}

case "${1:-}" in
  -h|--help) usage; exit 0 ;;
  --version) printf '%s\n' "$VERSION"; exit 0 ;;
esac

# shellcheck source=/usr/lib/outpost/lib.sh
source /usr/lib/outpost/lib.sh

fail=0
hdr "CAC readiness check"

# PC/SC
if systemctl is-enabled pcscd.socket >/dev/null 2>&1; then
  line "$(ok)" "pcscd.socket enabled"
else
  line "$(bad)" "pcscd.socket not enabled"
  fail=1
fi

if systemctl is-active pcscd.socket >/dev/null 2>&1; then
  line "$(ok)" "pcscd.socket active"
else
  line "$(warn)" "pcscd.socket not active (socket activation may be used)"
fi

if systemctl list-unit-files pcscd.service >/dev/null 2>&1; then
  if systemctl is-active pcscd.service >/dev/null 2>&1; then
    line "$(ok)" "pcscd.service active"
  else
    line "$(warn)" "pcscd.service not active (socket activation may be used)"
  fi
fi

printf '\n'

# OpenSC
OPENSC_LIB=""
for p in /usr/lib64/pkcs11/opensc-pkcs11.so /usr/lib64/opensc-pkcs11.so; do
  [[ -f "$p" ]] && OPENSC_LIB="$p" && break
done

if [[ -n "$OPENSC_LIB" ]]; then
  line "$(ok)" "OpenSC PKCS#11 module: $OPENSC_LIB"
else
  line "$(bad)" "OpenSC PKCS#11 module not found"
  fail=1
fi

if have opensc-tool; then
  line "$(ok)" "opensc-tool present"
else
  line "$(warn)" "opensc-tool not found"
fi

printf '\n'

# p11-kit
if have p11-kit; then
  if [[ -n "$OPENSC_LIB" ]] && p11-kit list-modules 2>/dev/null | grep -Fq "$OPENSC_LIB"; then
    line "$(ok)" "p11-kit sees OpenSC"
  else
    line "$(warn)" "p11-kit did not list OpenSC (may still work via proxy)"
  fi
else
  line "$(warn)" "p11-kit not available"
fi

printf '\n'

# Trust
ANCHOR="/etc/pki/ca-trust/source/anchors/dod-trust-bundle.pem"
if [[ -f "$ANCHOR" ]]; then
  line "$(ok)" "DoD trust anchor installed"
else
  line "$(bad)" "DoD trust anchor missing: $ANCHOR"
  fail=1
fi

if have trust-dod; then
  if trust-dod >/dev/null 2>&1; then
    line "$(ok)" "Trust store contains DoD-related CA entries"
  else
    line "$(warn)" "No DoD-related trust anchors found"
  fi
elif have trust; then
  if trust list --filter=ca-anchors 2>/dev/null | grep -Ei '(dod)' >/dev/null 2>&1; then
    line "$(ok)" "Trust store contains DoD-related CA entries"
  else
    line "$(warn)" "No DoD-related trust anchors found"
  fi
else
  line "$(warn)" "'trust' command not available"
fi

printf '\n'

# NSS
NSSDB_DIR="$HOME/.pki/nssdb"
NSSDB="sql:$NSSDB_DIR"

if have modutil; then
  if [[ -f "$NSSDB_DIR/cert9.db" ]]; then
    if modutil -list -dbdir "$NSSDB" 2>/dev/null | grep -Eqi '(p11-kit-proxy|opensc-pkcs11\.so)'; then
      line "$(ok)" "NSS has a PKCS#11 provider configured"
    else
      line "$(warn)" "NSS did not list a CAC PKCS#11 provider"
    fi
  else
    line "$(warn)" "NSS database not initialized (~/.pki/nssdb)"
  fi
else
  line "$(warn)" "modutil not available"
fi

exit "$fail"
