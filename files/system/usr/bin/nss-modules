#!/usr/bin/env bash
set -euo pipefail

VERSION="1.2"

usage() {
  cat <<'EOF'
Usage: nss-modules [--help] [--version]

Lists PKCS#11 modules configured in the NSS database used by Firefox.

EOF
}

case "${1:-}" in
  -h|--help) usage; exit 0 ;;
  --version) printf '%s\n' "$VERSION"; exit 0 ;;
esac

# shellcheck source=../lib/outpost/lib.sh
source /usr/lib/outpost/lib.sh

NSSDB_DIR="${HOME}/.pki/nssdb"
NSSDB="sql:${NSSDB_DIR}"

if ! have modutil; then
  line "$(bad)" "modutil not found"
  exit 1
fi

hdr "NSS modules"
dim "Listing PKCS#11 modules in your NSS database."
printf '\n'

if [[ ! -f "${NSSDB_DIR}/cert9.db" ]]; then
  line "$(warn)" "NSS database not initialized: ${NSSDB_DIR}"
  dim "Run Firefox once and try again."
  exit 1
fi

output="$(
  modutil -list -dbdir "$NSSDB" 2>&1 \
    | grep -v '^[[:space:]]*uri:' \
    | grep -v '^[[:space:]]*Listing' \
    | grep -v '^[[:space:]]*-' \
    || true
)"

if [[ -z "$output" ]]; then
  line "$(warn)" "No NSS modules found"
  exit 1
fi

gum style --border rounded --padding "0 1" --border-foreground 244 <<< "$output"
printf '\n'
line "$(ok)" "NSS modules listed"
exit 0
