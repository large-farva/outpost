#!/usr/bin/env bash
set -euo pipefail

VERSION="1.2"

usage() {
  cat <<'EOF'
Usage: cac-help [--help] [--version]

Interactive menu for Outpost CAC helpers.

EOF
}

case "${1:-}" in
  -h|--help) usage; exit 0 ;;
  --version) printf '%s\n' "$VERSION"; exit 0 ;;
esac

have() { command -v "$1" >/dev/null 2>&1; }

hdr() {
  gum style --border rounded --padding "0 1" --margin "0 0 1 0" \
    --border-foreground 68 --foreground 68 --bold "Outpost CAC helpers"
}

dim()  { gum style --foreground 244 "$*"; }
ok()   { gum style --foreground 42  --bold "✓"; }
warn() { gum style --foreground 214 --bold "!"; }
bad()  { gum style --foreground 196 --bold "✗"; }

line() {
  local icon="$1"; shift
  printf '%s %s\n' "$icon" "$*"
}

pause() {
  printf '\n'
  dim "Press Enter to return"
  read -r
}

run_cmd() {
  local label="$1"; shift
  local rc=0

  printf '\n'
  line "$(ok)" "$label"
  printf '\n'

  set +e
  "$@"
  rc=$?
  set -e

  printf '\n'
  if [[ $rc -eq 0 ]]; then
    line "$(ok)" "Completed"
  else
    line "$(warn)" "Exited with code $rc"
  fi

  return 0
}

rows=()
add_row() { rows+=("$1|$2"); }

menu_items=()
add_item() { menu_items+=("$1"); }

if have cac-check;    then add_row "cac-check"    "CAC readiness checks and diagnostics"; add_item "cac-check"; fi
if have scan;         then add_row "scan"         "Monitor reader and card events";        add_item "scan"; fi
if have reader-list;  then add_row "reader-list"  "List detected smart card readers";      add_item "reader-list"; fi
if have nss-modules;  then add_row "nss-modules"  "List NSS PKCS#11 modules (Firefox)";    add_item "nss-modules"; fi
if have trust-dod;    then add_row "trust-dod"    "Show DoD-related trust anchors";        add_item "trust-dod"; fi

add_item "Quit"

while true; do
  hdr

  if ((${#rows[@]})); then
    {
      printf "Command|Description\n"
      printf "%s\n" "${rows[@]}"
    } | gum table -s '|' -p --widths 18,70
    printf '\n'
  else
    line "$(warn)" "No CAC helpers found in PATH"
    printf '\n'
  fi

  choice="$(
    printf '%s\n' "${menu_items[@]}" | gum choose --height 10 \
      --header "Select a command" \
      --header.foreground="15" \
      --cursor.foreground="75" \
      --selected.foreground="68"
  )"

  case "$choice" in
    "Quit") exit 0 ;;

    "cac-check")
      run_cmd "Running cac-check" cac-check
      pause
      ;;

    "scan")
      run_cmd "Starting scan" scan
      pause
      ;;

    "reader-list")
      run_cmd "Listing readers" reader-list
      pause
      ;;

    "nss-modules")
      run_cmd "Listing NSS modules" nss-modules
      pause
      ;;

    "trust-dod")
      run_cmd "Showing DoD trust anchors" trust-dod
      pause
      ;;

    *)
      line "$(warn)" "Unknown selection: $choice"
      pause
      ;;
  esac
done
