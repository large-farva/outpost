#!/usr/bin/env bash
set -euo pipefail

VERSION="1.2"

usage() {
  cat <<'EOF'
Usage: cac-help [--help] [--version]

Interactive menu for Outpost CAC helpers.

EOF
}

case "${1:-}" in
  -h|--help) usage; exit 0 ;;
  --version) printf '%s\n' "$VERSION"; exit 0 ;;
esac

# shellcheck source=/usr/lib/outpost/lib.sh
source /usr/lib/outpost/lib.sh

pause() {
  printf '\n'
  dim "Press Enter to return"
  read -r
}

run_cmd() {
  local label="$1"; shift
  local rc=0

  printf '\n'
  line "$(ok)" "$label"
  printf '\n'

  set +e
  "$@"
  rc=$?
  set -e

  printf '\n'
  if [[ $rc -eq 0 ]]; then
    line "$(ok)" "Completed"
  else
    line "$(warn)" "Exited with code $rc"
  fi

  return 0
}

declare -A COMMANDS=(
  [cac-check]="CAC readiness checks and diagnostics"
  [scan]="Monitor reader and card events"
  [reader-list]="List detected smart card readers"
  [nss-modules]="List NSS PKCS#11 modules (Firefox)"
  [trust-dod]="Show DoD-related trust anchors"
)

COMMAND_ORDER=(cac-check scan reader-list nss-modules trust-dod)

rows=()
menu_items=()

for cmd in "${COMMAND_ORDER[@]}"; do
  if have "$cmd"; then
    rows+=("$cmd|${COMMANDS[$cmd]}")
    menu_items+=("$cmd")
  fi
done

menu_items+=("Quit")

while true; do
  hdr "Outpost CAC helpers"

  if ((${#rows[@]})); then
    {
      printf "Command|Description\n"
      printf "%s\n" "${rows[@]}"
    } | gum table -s '|' -p --widths 18,70
    printf '\n'
  else
    line "$(warn)" "No CAC helpers found in PATH"
    printf '\n'
  fi

  choice="$(
    printf '%s\n' "${menu_items[@]}" | gum choose --height 10 \
      --header "Select a command" \
      --header.foreground="15" \
      --cursor.foreground="75" \
      --selected.foreground="68"
  )"

  if [[ "$choice" == "Quit" ]]; then
    exit 0
  elif have "$choice"; then
    run_cmd "Running $choice" "$choice"
    pause
  else
    line "$(warn)" "Unknown selection: $choice"
    pause
  fi
done
