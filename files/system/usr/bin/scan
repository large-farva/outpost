#!/usr/bin/env bash
set -euo pipefail

VERSION="1.2"

usage() {
  cat <<'EOF'
Usage: scan [--help] [--version] [-- pcsc_scan args...]

Runs pcsc_scan interactively to monitor smart card reader events.
Press Enter to stop the scan.

EOF
}

case "${1:-}" in
  -h|--help) usage; exit 0 ;;
  --version) printf '%s\n' "$VERSION"; exit 0 ;;
esac

# shellcheck source=lib.sh
source /usr/lib/outpost/lib.sh

if ! have pcsc_scan; then
  line "$(bad)" "pcsc_scan not found"
  exit 1
fi

hdr "CAC scan"
dim "Connect your CAC reader and insert your CAC."
dim "If nothing appears, the reader may not be detected."
dim "Press Enter to stop the scan."
printf '\n'

if ! gum confirm --selected.background="68" "Start pcsc_scan now?"; then
  line "$(warn)" "Canceled"
  exit 0
fi

printf '\n'
line "$(ok)" "Starting scan..."

pcsc_scan "$@" &
pid=$!

cleanup() {
  if kill -0 "$pid" 2>/dev/null; then
    kill -INT "$pid" 2>/dev/null || true
    sleep 0.2
    kill -TERM "$pid" 2>/dev/null || true
  fi
}

trap cleanup EXIT INT TERM

while kill -0 "$pid" 2>/dev/null; do
  read -r -t 1 _ && break
done

line "$(warn)" "Stopping scan..."
cleanup

wait "$pid" 2>/dev/null || true
exit 0
